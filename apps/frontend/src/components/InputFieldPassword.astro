---
interface Props {
  id: string;
  label: string;
  required?: boolean;
  placeholder?: string;
}

const { id, label, required = false, placeholder } = Astro.props;
---

<div class="input-group">
  <label for={id}>{label}</label>
  <div class="password-wrapper">
    <input
      id={id}
      name={id}
      type="password"
      required={required}
      placeholder={placeholder}
      aria-required={required ? "true" : "false"}
      data-password-input
    />
    <button type="button" class="toggle-password" data-toggle-password aria-label="Afficher le mot de passe">
      <svg class="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 5C7 5 2.73 8.11 1 12.5C2.73 16.89 7 20 12 20C17 20 21.27 16.89 23 12.5C21.27 8.11 17 5 12 5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z" fill="currentColor"/>
      </svg>
      <svg class="eye-off-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <path d="M12 7C14.76 7 17 9.24 17 12C17 12.65 16.87 13.26 16.64 13.83L19.56 16.75C21.07 15.49 22.26 13.86 23 12C21.27 7.61 17 4.5 12 4.5C10.6 4.5 9.26 4.75 8.04 5.2L10.17 7.33C10.74 7.13 11.35 7 12 7ZM2 4.27L4.28 6.55L4.74 7.01C3.08 8.3 1.78 10.02 1 12C2.73 16.39 7 19.5 12 19.5C13.55 19.5 15.03 19.2 16.38 18.66L16.8 19.08L19.73 22L21 20.73L3.27 3L2 4.27ZM7.53 9.8L9.08 11.35C9.03 11.56 9 11.78 9 12C9 13.66 10.34 15 12 15C12.22 15 12.44 14.97 12.65 14.92L14.2 16.47C13.53 16.8 12.79 17 12 17C9.24 17 7 14.76 7 12C7 11.21 7.2 10.47 7.53 9.8ZM11.84 9.02L14.99 12.17L15.01 12.01C15.01 10.35 13.67 9.01 12.01 9.01L11.84 9.02Z" fill="currentColor"/>
      </svg>
    </button>
  </div>
  <p class="password-hint" data-password-hint></p>
  <div class="chess-board" data-chess-board style="display: none;">
    <div class="chess-container">
      <div class="chess-labels-left">
        <div class="label-row">8</div>
        <div class="label-row">7</div>
        <div class="label-row">6</div>
        <div class="label-row">5</div>
        <div class="label-row">4</div>
        <div class="label-row">3</div>
        <div class="label-row">2</div>
        <div class="label-row">1</div>
      </div>
      <div class="chess-main">
        <div class="chess-grid">
      <div class="square light"><span style="color: black;">♜</span></div>
      <div class="square dark"><span style="color: black;">♞</span></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"><span style="color: black;">♚</span></div>

      <div class="square dark"><span style="color: white;">♖</span></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>

      <div class="square light"></div>
      <div class="square dark"><span style="color: black;">♟</span></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"><span style="color: black;">♟</span></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>

      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>

      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>

      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"><span style="color: white;">♕</span></div>
      <div class="square light"></div>

      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"><span style="color: black;">♟</span></div>
      <div class="square dark"></div>

      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"><span style="color: white;">♔</span></div>
        </div>
        <div class="chess-labels-bottom">
          <div class="label-col">a</div>
          <div class="label-col">b</div>
          <div class="label-col">c</div>
          <div class="label-col">d</div>
          <div class="label-col">e</div>
          <div class="label-col">f</div>
          <div class="label-col">g</div>
          <div class="label-col">h</div>
        </div>
      </div>
    </div>
    <p class="chess-hint">Échec et mat en 1 coup - Les blancs jouent</p>
  </div>
</div>

<script>
  const passwordInputs = document.querySelectorAll('[data-password-input]');

  passwordInputs.forEach(input => {
    const hint = input.parentElement?.parentElement?.querySelector('[data-password-hint]') as HTMLElement;
    const toggleBtn = input.parentElement?.querySelector('[data-toggle-password]') as HTMLButtonElement;

    if (!hint) return;

    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        const inputEl = input as HTMLInputElement;
        const eyeIcon = toggleBtn.querySelector('.eye-icon') as SVGElement;
        const eyeOffIcon = toggleBtn.querySelector('.eye-off-icon') as SVGElement;
        if (inputEl.type === 'password') {
          inputEl.type = 'text';
          eyeIcon.style.display = 'none';
          eyeOffIcon.style.display = 'block';
          toggleBtn.setAttribute('aria-label', 'Masquer le mot de passe');
        } else {
          inputEl.type = 'password';
          eyeIcon.style.display = 'block';
          eyeOffIcon.style.display = 'none';
          toggleBtn.setAttribute('aria-label', 'Afficher le mot de passe');
        }
      });
    }

    const allSteps = [
      { id: 1, check: (p: string) => /[A-Z]/.test(p), message: "Ajoutez une majuscule" },
      { id: 2, check: (p: string) => /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(p), message: "Ajoutez un caractère spécial" },
      { id: 3, check: (p: string) => /[0-9]/.test(p), message: "Ajoutez un chiffre" },
      { id: 4, check: (p: string) => /[a-z]/.test(p), message: "Ajoutez une minuscule" },
      { id: 6, check: (p: string) => {
        const digits = p.match(/\d/g);
        const sum = digits ? digits.reduce((acc, d) => acc + parseInt(d), 0) : 0;
        return sum === 25;
      }, message: "Les chiffres de votre mot de passe doivent faire 25" },
      { id: 7, check: (p: string) => /january|february|march|april|may|june|july|august|september|october|november|december/i.test(p), message: "Ajoutez un mois de l'année en anglais" },
      { id: 9, check: (p: string) => /[IVXLCDM]{2,}/.test(p), message: "Ajoutez un nombre romain (minimum 2 lettres)" },
      { id: 11, check: (p: string) => /[aeiouy]/i.test(p), message: "Ajoutez une voyelle" },
      { id: 13, check: (p: string) => /lunes|martes|miercoles|jueves|viernes|sabado|domingo/i.test(p), message: "Ajoutez un jour de la semaine en espagnol" },
      { id: 15, check: (p: string) => /π|pi/i.test(p), message: "Ajoutez π (pi ou π)" },
      { id: 16, check: (p: string) => {
        const consonants = p.match(/[bcdfghjklmnpqrstvwxyz]/gi);
        return consonants && consonants.length >= 5;
      }, message: "Ayez au moins 5 consonnes" },
      { id: 17, check: (p: string) => {
        const unique = new Set(p.toLowerCase());
        return unique.size >= 10;
      }, message: "Utilisez au moins 10 caractères différents" },
      { id: 18, check: (p: string) => /red|blue|yellow|black|white/i.test(p), message: "Ajoutez une couleur primaire en anglais" },
      { id: 19, check: (p: string) => /cat|dog/i.test(p), message: "Ajoutez le meilleur ami de l'homme en anglais" },
      { id: 21, check: (p: string) => /espagne|italie|allemagne|belgique|suisse|luxembourg/i.test(p), message: "Ajoutez un pays frontalier à la France" },
      { id: 23, check: (p: string) => /[@#$]/.test(p), message: "Utilisez @, # ou $" },
      { id: 24, check: (p: string) => {
        const digits = p.match(/\d/g);
        return digits && digits.length >= 3;
      }, message: "Ayez au moins 3 chiffres" },
      { id: 26, check: (p: string) => /fire|water|earth|air/i.test(p), message: "Ajoutez un élément en anglais" },
      { id: 27, check: (p: string) => /love|hate|happy|sad|angry|joy/i.test(p), message: "Ajoutez une émotion en anglais" },
      { id: 28, check: (p: string) => {
        const upper = p.match(/[A-Z]/g);
        return upper && upper.length >= 2;
      }, message: "Ayez au moins 2 majuscules" },
      { id: 29, check: (p: string) => /mercury|venus|earth|mars|jupiter|saturn|uranus|neptune/i.test(p), message: "Ajoutez une planète du système solaire en toutes lettres en anglais" },
      { id: 30, check: (p: string) => /alpha|beta|gamma|delta|omega/i.test(p), message: "Ajoutez une lettre grecque en toutes lettres (omega, alpha, gamma..." },
      { id: 31, check: (p: string) => /spring|summer|autumn|fall|winter/i.test(p), message: "Ajoutez une saison en anglais" },
      { id: 32, check: (p: string) => /north|south|east|west/i.test(p), message: "Ajoutez un point cardinal en anglais" },
      { id: 33, check: (p: string) => /avión/i.test(p), message: "Ajoutez le mot avion en argonais" },
      { id: 34, check: (p: string) => /strawberry|cherry|raspberry|watermelon|tomato|apple|cranberry/i.test(p), message: "Ajoutez un fruit rouge en anglais" },
    ];

    const shuffled = [...allSteps];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    const steps = shuffled.slice(0, 17);

    let currentStep = 0;
    hint.textContent = steps[0].message;
    hint.style.color = "rgb(203, 163, 35)";

    input.addEventListener('input', () => {
      const password = (input as HTMLInputElement).value;

      if (currentStep < steps.length) {
        let allPreviousValid = true;
        for (let i = 0; i <= currentStep; i++) {
          if (!steps[i].check(password)) {
            allPreviousValid = false;
            hint.textContent = steps[i].message;
            break;
          }
        }
        if (allPreviousValid && steps[currentStep].check(password)) {
          currentStep++;
          if (currentStep < steps.length) {
            hint.textContent = steps[currentStep].message;
          } else {
            hint.textContent = "Jouez la Dame - Trouvez la case d'arrivée (écrivez la réponse dans le champ de mot de passe, ex: h7)";
            const chessBoard = input.closest('.input-group')?.querySelector('[data-chess-board]') as HTMLElement;
            if (chessBoard) {
              chessBoard.style.display = 'block';
            }
          }
        }
      } else {
        const chessAnswer = ['g7', 'G7', 'Qg7', 'qg7'];
        if (chessAnswer.some(answer => password.includes(answer))) {
          hint.textContent = "✅ Mot de passe accepté !";
          hint.style.color = "#00ff00";
          const chessBoard = input.closest('.input-group')?.querySelector('[data-chess-board]') as HTMLElement;
          if (chessBoard) {
            chessBoard.style.display = 'none';
          }
        } else {
          hint.textContent = "Jouez la Dame - Entrez la case d'arrivée dans le champ de mot de passe (ex: h7)";
        }
      }
    });
  });
</script>

<style>
  .input-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  label {
    font-weight: 500;
    color: #FFFFFF;
  }

  .password-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  input {
    padding: 0.75rem;
    padding-right: 3rem;
    border: 1px solid rgb(80, 80, 80);
    border-radius: 20px;
    font-size: 1rem;
    background: rgb(30, 30, 30);
    color: #FFFFFF;
    flex: 1;
  }

  input:focus {
    outline: 2px solid rgb(203, 163, 35);
    outline-offset: 2px;
  }

  .toggle-password {
    position: absolute;
    right: 0.75rem;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
    color: rgb(203, 163, 35);
  }

  .toggle-password:hover {
    transform: scale(1.1);
    color: rgb(220, 180, 50);
  }

  .password-hint {
    font-size: 0.875rem;
    margin: 0;
    min-height: 1.25rem;
    transition: color 0.3s ease;
  }

  .chess-board {
    margin-top: 1rem;
    padding: 1rem;
    background: rgb(46, 46, 46);
    border-radius: 8px;
    animation: slideDown 0.3s ease;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .chess-container {
    display: flex;
    gap: 0.5rem;
    width: fit-content;
    margin: 0 auto;
  }

  .chess-labels-left {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
  }

  .label-row {
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgb(203, 163, 35);
    font-weight: bold;
    font-size: 0.9rem;
    width: 20px;
  }

  .chess-main {
    display: flex;
    flex-direction: column;
  }

  .chess-labels-bottom {
    display: flex;
    justify-content: space-around;
    margin-top: 0.25rem;
  }

  .label-col {
    width: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgb(203, 163, 35);
    font-weight: bold;
    font-size: 0.9rem;
  }

  .chess-grid {
    display: grid;
    grid-template-columns: repeat(8, 40px);
    grid-template-rows: repeat(8, 40px);
    gap: 0;
    border: 2px solid rgb(203, 163, 35);
  }

  .square {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
  }

  .square.light {
    background: #f0d9b5;
  }

  .square.dark {
    background: #b58863;
  }

  .chess-hint {
    margin-top: 0.75rem;
    font-size: 0.9rem;
    color: rgb(203, 163, 35);
    text-align: center;
  }
</style>
