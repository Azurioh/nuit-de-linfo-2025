---
interface Props {
  id: string;
  label: string;
  required?: boolean;
  placeholder?: string;
}

const { id, label, required = false, placeholder } = Astro.props;
---

<div class="input-group">
  <label for={id}>{label}{required && <span aria-label="requis">*</span>}</label>
  <div class="password-wrapper">
    <input
      id={id}
      name={id}
      type="password"
      required={required}
      placeholder={placeholder}
      aria-required={required ? "true" : "false"}
      data-password-input
    />
    <button type="button" class="toggle-password" data-toggle-password aria-label="Afficher le mot de passe">
      üëÅÔ∏è
    </button>
  </div>
  <p class="password-hint" data-password-hint></p>
  <div class="chess-board" data-chess-board style="display: none;">
    <div class="chess-container">
      <div class="chess-labels-left">
        <div class="label-row">8</div>
        <div class="label-row">7</div>
        <div class="label-row">6</div>
        <div class="label-row">5</div>
        <div class="label-row">4</div>
        <div class="label-row">3</div>
        <div class="label-row">2</div>
        <div class="label-row">1</div>
      </div>
      <div class="chess-main">
        <div class="chess-grid">
      <!-- 8√®me rang√©e -->
      <div class="square light"><span style="color: black;">‚ôú</span></div>
      <div class="square dark"><span style="color: black;">‚ôû</span></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"><span style="color: black;">‚ôö</span></div>
      
      <!-- 7√®me rang√©e -->
      <div class="square dark"><span style="color: white;">‚ôñ</span></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      
      <!-- 6√®me rang√©e -->
      <div class="square light"></div>
      <div class="square dark"><span style="color: black;">‚ôü</span></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"><span style="color: black;">‚ôü</span></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      
      <!-- 5√®me rang√©e -->
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      
      <!-- 4√®me rang√©e -->
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      
      <!-- 3√®me rang√©e -->
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"><span style="color: white;">‚ôï</span></div>
      <div class="square light"></div>
      
      <!-- 2√®me rang√©e -->
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"><span style="color: black;">‚ôü</span></div>
      <div class="square dark"></div>
      
      <!-- 1√®re rang√©e -->
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"></div>
      <div class="square dark"></div>
      <div class="square light"><span style="color: white;">‚ôî</span></div>
        </div>
        <div class="chess-labels-bottom">
          <div class="label-col">a</div>
          <div class="label-col">b</div>
          <div class="label-col">c</div>
          <div class="label-col">d</div>
          <div class="label-col">e</div>
          <div class="label-col">f</div>
          <div class="label-col">g</div>
          <div class="label-col">h</div>
        </div>
      </div>
    </div>
    <p class="chess-hint">√âchec et mat en 1 coup - Les blancs jouent</p>
  </div>
</div>

<script>
  const passwordInputs = document.querySelectorAll('[data-password-input]');
  
  passwordInputs.forEach(input => {
    const hint = input.parentElement?.parentElement?.querySelector('[data-password-hint]') as HTMLElement;
    const toggleBtn = input.parentElement?.querySelector('[data-toggle-password]') as HTMLButtonElement;
    
    if (!hint) return;

    // Toggle password visibility
    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        const inputEl = input as HTMLInputElement;
        if (inputEl.type === 'password') {
          inputEl.type = 'text';
          toggleBtn.textContent = 'üôà';
        } else {
          inputEl.type = 'password';
          toggleBtn.textContent = 'üëÅÔ∏è';
        }
      });
    }

    // G√©n√©rer un ordre al√©atoire des √©tapes
    const allSteps = [
      { id: 1, check: (p: string) => /[A-Z]/.test(p), message: "Ajoutez une majuscule" },
      { id: 2, check: (p: string) => /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(p), message: "Ajoutez un caract√®re sp√©cial" },
      { id: 3, check: (p: string) => /[0-9]/.test(p), message: "Ajoutez un chiffre" },
      { id: 4, check: (p: string) => /[a-z]/.test(p), message: "Ajoutez une minuscule" },
      { id: 6, check: (p: string) => {
        const digits = p.match(/\d/g);
        const sum = digits ? digits.reduce((acc, d) => acc + parseInt(d), 0) : 0;
        return sum === 25;
      }, message: "Les chiffres de votre mot de passe doivent faire 25" },
      { id: 7, check: (p: string) => /january|february|march|april|may|june|july|august|september|october|november|december/i.test(p), message: "Ajoutez un mois de l'ann√©e en anglais" },
      { id: 9, check: (p: string) => /[IVXLCDM]{2,}/.test(p), message: "Ajoutez un nombre romain (minimum 2 lettres)" },
      { id: 11, check: (p: string) => /[aeiouy]/i.test(p), message: "Ajoutez une voyelle" },
      { id: 13, check: (p: string) => /lunes|martes|miercoles|jueves|viernes|sabado|domingo/i.test(p), message: "Ajoutez un jour de la semaine en espagnol" },
      { id: 15, check: (p: string) => /œÄ|pi/i.test(p), message: "Ajoutez œÄ (pi ou œÄ)" },
      { id: 16, check: (p: string) => {
        const consonants = p.match(/[bcdfghjklmnpqrstvwxyz]/gi);
        return consonants && consonants.length >= 5;
      }, message: "Ayez au moins 5 consonnes" },
      { id: 17, check: (p: string) => {
        const unique = new Set(p.toLowerCase());
        return unique.size >= 10;
      }, message: "Utilisez au moins 10 caract√®res diff√©rents" },
      { id: 18, check: (p: string) => /red|blue|green|yellow|purple|orange|pink|black|white/i.test(p), message: "Ajoutez une couleur en anglais" },
      { id: 19, check: (p: string) => /cat|dog|bird|fish|lion|tiger|elephant|monkey/i.test(p), message: "Ajoutez un animal en anglais" },
      { id: 21, check: (p: string) => /france|spain|italy|germany|japan|china|brazil|canada/i.test(p), message: "Ajoutez un pays" },
      { id: 23, check: (p: string) => /[@#$]/.test(p), message: "Utilisez @, # ou $" },
      { id: 24, check: (p: string) => {
        const digits = p.match(/\d/g);
        return digits && digits.length >= 3;
      }, message: "Ayez au moins 3 chiffres" },
      { id: 26, check: (p: string) => /fire|water|earth|air/i.test(p), message: "Ajoutez un √©l√©ment (fire, water, earth, air)" },
      { id: 27, check: (p: string) => /love|hate|happy|sad|angry|joy/i.test(p), message: "Ajoutez une √©motion en anglais" },
      { id: 28, check: (p: string) => {
        const upper = p.match(/[A-Z]/g);
        return upper && upper.length >= 2;
      }, message: "Ayez au moins 2 majuscules" },
      { id: 29, check: (p: string) => /sun|moon|star|planet|galaxy/i.test(p), message: "Ajoutez un objet c√©leste en anglais" },
      { id: 30, check: (p: string) => /alpha|beta|gamma|delta|omega/i.test(p), message: "Ajoutez une lettre grecque (alpha, beta, gamma...)" },
      { id: 31, check: (p: string) => /spring|summer|autumn|fall|winter/i.test(p), message: "Ajoutez une saison en anglais" },
      { id: 32, check: (p: string) => /north|south|east|west/i.test(p), message: "Ajoutez un point cardinal en anglais" },
      { id: 33, check: (p: string) => /avi√≥n/i.test(p), message: "Ajoutez le mot avion en argonais" },
      { id: 34, check: (p: string) => /apple|banana|orange|grape|lemon/i.test(p), message: "Ajoutez un fruit en anglais" },
    ];

    // S√©lectionner 17 √©tapes al√©atoires (sans r√©p√©tition)
    const shuffled = [...allSteps];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    const steps = shuffled.slice(0, 17);

    let currentStep = 0;
    hint.textContent = steps[0].message;
    hint.style.color = "rgb(203, 163, 35)";

    input.addEventListener('input', () => {
      const password = (input as HTMLInputElement).value;

      // V√©rifier l'√©tape actuelle et toutes les pr√©c√©dentes
      if (currentStep < steps.length) {
        // V√©rifier toutes les √©tapes jusqu'√† la courante
        let allPreviousValid = true;
        for (let i = 0; i <= currentStep; i++) {
          if (!steps[i].check(password)) {
            allPreviousValid = false;
            hint.textContent = steps[i].message;
            break;
          }
        }
        
        // Si toutes les √©tapes pr√©c√©dentes sont valides, passer √† la suivante
        if (allPreviousValid && steps[currentStep].check(password)) {
          currentStep++;
          if (currentStep < steps.length) {
            hint.textContent = steps[currentStep].message;
          } else {
            hint.textContent = "Jouez la Dame - Trouvez la case d'arriv√©e";
            const chessBoard = input.closest('.input-group')?.querySelector('[data-chess-board]') as HTMLElement;
            if (chessBoard) {
              chessBoard.style.display = 'block';
            }
          }
        }
      } else {
        // √âtape finale : √âchec et mat
        const chessAnswer = ['g7', 'G7', 'Qg7', 'qg7'];
        if (chessAnswer.some(answer => password.includes(answer))) {
          hint.textContent = "‚úÖ Mot de passe accept√© !";
          hint.style.color = "#00ff00";
          const chessBoard = input.closest('.input-group')?.querySelector('[data-chess-board]') as HTMLElement;
          if (chessBoard) {
            chessBoard.style.display = 'none';
          }
        } else {
          hint.textContent = "Jouez la Dame - Entrez la case d'arriv√©e (ex: h7)";
        }
      }
    });
  });
</script>

<style>
  .input-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  label {
    font-weight: 500;
    color: #FFFFFF;
  }

  .password-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }
  
  input {
    padding: 0.75rem;
    padding-right: 3rem;
    border: 1px solid rgb(80, 80, 80);
    border-radius: 20px;
    font-size: 1rem;
    background: rgb(30, 30, 30);
    color: #FFFFFF;
    flex: 1;
  }
  
  input:focus {
    outline: 2px solid rgb(203, 163, 35);
    outline-offset: 2px;
  }

  .toggle-password {
    position: absolute;
    right: 0.75rem;
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 1.25rem;
    padding: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
  }

  .toggle-password:hover {
    transform: scale(1.1);
  }

  .password-hint {
    font-size: 0.875rem;
    margin: 0;
    min-height: 1.25rem;
    transition: color 0.3s ease;
  }

  .chess-board {
    margin-top: 1rem;
    padding: 1rem;
    background: rgb(46, 46, 46);
    border-radius: 8px;
    animation: slideDown 0.3s ease;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .chess-container {
    display: flex;
    gap: 0.5rem;
    width: fit-content;
    margin: 0 auto;
  }

  .chess-labels-left {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
  }

  .label-row {
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgb(203, 163, 35);
    font-weight: bold;
    font-size: 0.9rem;
    width: 20px;
  }

  .chess-main {
    display: flex;
    flex-direction: column;
  }

  .chess-labels-bottom {
    display: flex;
    justify-content: space-around;
    margin-top: 0.25rem;
  }

  .label-col {
    width: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgb(203, 163, 35);
    font-weight: bold;
    font-size: 0.9rem;
  }

  .chess-grid {
    display: grid;
    grid-template-columns: repeat(8, 40px);
    grid-template-rows: repeat(8, 40px);
    gap: 0;
    border: 2px solid rgb(203, 163, 35);
  }

  .square {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
  }

  .square.light {
    background: #f0d9b5;
  }

  .square.dark {
    background: #b58863;
  }

  .chess-hint {
    margin-top: 0.75rem;
    font-size: 0.9rem;
    color: rgb(203, 163, 35);
    text-align: center;
  }
</style>
